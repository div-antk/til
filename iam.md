# IAM

## 概要

Identity and Access Manegement。  
AWSを操作するための認証、認可の仕組み

- 利用者認証の実施
- アクセスポリシー
- ユーザー、グループごとに「EC2にはアクセスできるけどS3にはアクセスできないよ」といった設定

### 主要トピック（4つ）

#### ユーザー

- ルートユーザー（通常の管理には利用しない。日常的なタスクはルートユーザーを使用しないのが望ましい）
- IAMユーザー（ポリシー内でAWSサービスを利用できる。基本操作はこっち）

#### グループ

- IAMグループ

#### ポリシー

- JSONを使ったアクセス権限の付与
- 管理ポリシー（『うちの会社としてはこういうポリシーだよ』といったもの）
- インラインポリシー（ロールにアタッチされるもの）
- JSON形式。Effect（許可不許可）、Action（対象のAWSサービス）、Resource（対象のAWSリソース）、Condition（アクセス制御が有効になる条件）

#### ロール

- リソースに対するポリシー。S3などの一部のサービスに対して他のサービスへのアクセス制限を付与できる

### 責任共有モデル

- 「AWS側はここまで責任を持ちます、ユーザー側がここまで管理してください」というものが定義されている

#### AWS側の責任範囲

AWSインフラストラクチャ（ハードウェア、ソフトウェア、ネットワーク）、AWSデータセンター

#### ユーザー側の責任範囲

ユーザーが作ったAWSインフラストラクチャ、ユーザーアクセス、ロールベースのアクセス、ユーザーが利用するAWSサービス

どのように管理するのか？

- IAM
- セキュリティグループ

### ユーザーのアクティビティの記録

#### Access AdvisorのService Last Accessed Data

- 最後にAWSサービスにアクセスした日付と時刻

#### Credential Report

- 利用日時のレポートファイル

#### AWS Config

- ポリシーの変更履歴、構成変更の管理、確認

#### AWS Cloud Traik

- インフラ全体のアクティビティログ

### アクセス権限の一時付与

- Security Token Service（STS）
- Temporary Secutiry Credentials

## 設計

- ベストプラクティスに沿ったIAM設計をする
- 少数利用ではユーザー、人数が多ければグループを作る
- 一時利用にはSTSで最小限の使用許可を与える

### グループ設計

- 利用者と役割の洗い出し -> 利用グループへと集約

## IAMグループへのポリシー適用

### IT管理者

- ルートユーザーも保持して権限設定などの責任を負っている
- フルアクセスの管理権限の付与
- Administrator

### 運用管理者

- 様々なモニタリングと障害対応などで直接アプリに触れることもある
- 運用ツール全般と開発環境へのアクセスもふy椅子てDevOpsに参加できるようにする
- ELB, EC2, RDB, S3, Auto-Scaling, VPC Config, Trail, CloudWatch

### アプリ開発者

- 主なAWSサービスを利用して開発を行っている
- 担当しているアプリの開発範囲でのみアクセス権限を付与
- ELB, EC2, RDB, S3, Auto-Scaling, VPC

### ポリシーの作成

- サービス（EC2とか）
- アクション（『すべてのアクション』）
- リソース（『すべてのリソース』。本来であれば使うべきリソースの制限をする）
- リクエスト条件（オプションとして選べる）
- VPCに関しては許可範囲がEC2の中で設定されている
- アプリケーション開発者用とか運用管理者用で作る
- `グループの作成` でグループを作り、上で作ったポリシーを付与する

## IAMロールへのポリシー適用

### 『EC2インスタンスがバッチ処理でS3にデータを保存する』と仮定した場合

- EC2インスタンスにS3へのアクセス権限を設定
- 『ロールの作成』からEC2を選ぶ
- グループでポリシーを作ったときと同じようにS3のみ許可するポリシーを作成する
- 『リクエスト』でEC2のIPアドレスを設定するほうがセキュリティ的には望ましい
- 作成後はEC2のインスタンスの画面から『IAMロールの割り当て/置換』を選択して、作ったポリシーを付与する
