# Auto-Scaling

- 信頼とパフォーマンスに影響するスケーラビリティの確保である
- またベストプラクティスにおける「使い捨てリソースの使用」にもこれが重要になってくる
  - サーバーなどのコンポーネントを一時的なリソースとして利用、設計する
  - リソースを自動で減らしたり増やしたり

## スケーラビリティの確保

- 需要増にトラフィック量が処理できなくなる前に、処理サーバーを拡張することで対処する必要がある
- ELBでトラフィック量をチェックをしてはいるが、トラフィック量があまりにも増えると分散しても処理できなくなる
  - その場合新しいサーバーを増やす必要があるが、オンプレだとこれが諸々の手続きで1ヶ月くらいかかる。それをクラウド上で自動でやってくれるのがコレ

## スケーリングのタイプ

- 垂直スケーリングと水平スケーリングの2タイプがある
- Auto-Scalingは水平スケーリング

|      | 垂直スケーリング                 | 水平スケーリング                    |
| ---- | ------------------------ | --------------------------- |
| 拡張方法 | スケールアップ: メモリやCPUの追加、増強（サーバー内の機能を高める）   | スケールアウト: 処理する機器、サーバー台数を増加する（機器自体を増やす） |
| 低減方法 | スケールダウン: メモリやCPUの削減、低性能化 | スケールイン: 処理する機器、サーバー台数を低減する  |

## Auto-Scalingの要素

主に3つの要素で構成される

1. Auto-Scalingグループ
2. Auto-Scaling configuration: 起動設定
3. スケーリングプラン

### Auto-Scalingグループ

スケーリングするインスタンスの最大数など、基本情報を設定する

- 起動インスタンスの最小数と最大数を設定する
- 現時点で必要である最適なインスタンス数（Desired Capacity）の数量になるようにインスタンスを起動、終了を調整
- 起動台数をAZ間でバランシングする
- AZ障害時は、障害のない別のAZにその分のインスタンスを起動する

### Auto-Scaling configuration: 起動設定

スケールアウトの際に起動するインスタンス内容を設定する

- 主要な設定項目
  - AMI
  - インスタンスタイプ
  - セキュリティグループ
  - キーペア
  - IAMロール

### スケーリングプラン

どのようにスケールするかの方法を定義する。  
複数組み合わせて利用することができる

- スケーリングをスケジュールで設定 -> スケジュール設定を超過したら動的スケーリングに切り替わる など

#### Auto-Scaling Groupサイズの維持
  
- 現在のAuto-Scaling Groupのインスタンス最小台数を維持する設定をする

#### 主導スケーリング

- 設定外で予期せぬスケーリングが必要になった場合に手動でスケーリングを実施

#### スケジュールベース

- 予測された需要増加時期にあわせたスケーリングスケジュールを設定

#### 動的スケーリング

- 予測不能なケースにスケーリングポリシーにスケール方法を設定して、動的にスケールアウトを実施

## ヘルスチェック

Auto-Scaling配下のEC2のヘルスチェックにはEC2のステータス情報、またはELBのヘルスチェックのどちらかを参照して行う

- EC2ステータス
  - インスタンスのステータスがrunning以外の状態を異常と判断
- ELB
  - ELBのヘルスチェック機能を活用する
  - トラフィック量の処理状況

## ターミネーションポリシー

需要減に基づくスケールインの際にどのインスタンスから終了するかを設定

- ① OldestInstance / NewestInstance
  - 最も古いインスタンスや、新しい起動時刻のインスタンスなどの順から終了
- ② OldestLaunch Configuration
  - 最も古い起動設定により、起動しているインスタンスから終了
- ③ ClosestToNextInstanceHour
  - 次の課金が始まるタイミングが最も近いインスタンスから終了
- ④ デフォルト設定
  - ②③の順に適応する。その後、複数のインスタンスが残った場合はランダムに終了する

## 連携

ELBのヘルスチェックやCloudWatchのアラート機能をトリガーとして利用できる。基本は下記

- ELB -> Auto-Scaling
  - これが基本
- CloudWatch -> Auto-Scaling

## 基本アーキテクチャ

ELB構成で冗長化した上でAuto-Scalingを設定して自動拡張できるようにする

## Auto-Scaling設定プロセス

1. ALBの作成
2. ターゲットグループの作成
3. 起動するインスタンス設定
4. Auto-Scalingグループ作成

この次は以下のどちらか

- Auto-Scalingポリシー作成
- スケジュール設定

## Auto-Scaling設定ポイント

- インスタンスの最大値、最小値の設定は慎重に設定する
- ステートフルなアプリケーションの設定には、Auto-Scaling Groupでの自動設定が必要
- ライフサイクルフック（起動時、または削除時にインスタンスを一時停止してカスタムアクションを実行）を使用
  - ターミネーションする際にログを残すか？などの設定
- Auto-Scalingスラッシング（急なスケールインによる影響）を避ける

## ELBにAuto-Scalingを設定するハンズオンのメモ

- EC2の左メニューから『Auto-Scalingグループの作成』
  - 「Auto-Scalingでどういうインスタンスを作るのか？」という設定なので、EC2の設定とほぼ同じ
- 『マイAMI』からテンプレを選べる
- 『既存のセキュリティーグループ』から選ぶ
- キーペア選んで作成できたらグループ名の設定
  - 『グループサイズ』は2インスタンス
  - 『サブネット』でパブリックのものを2つ選ぶ
    - VPCのコンソールからサブネットを選んでIPの自動割り当てを有効にする必要がある
  - 『高度な設定』からロードバランシングを設定する
    - 『ターゲットグループ』から選択
    - 『ヘルスチェックタイプ』はELB
- 『スケーリングポリシーを使用して、このグループのキャパシティを調整する』
  - スケーリング範囲を「2および4インスタンス」にする
  - 『ステップスケーリングポリシーまたは簡易スケーリングポリシーを〜』をクリックして、グループサイズの増減に関する細かい設定を行う
    - アラームの追加で『通知』のチェックを外し、今回は「CPU使用率が50％を超えたら」という設定をした。それ以外はそのまま
    - 『アクションを実行』で2インスタンスを追加する設定
    - 減少のほうは「CPU使用率が15％」の設定をした
      - アラーム名が増加とダブルとエラーになるので適当に変更
    - 2インスタンス減少する設定にする
- タグには増加したサーバーということがわかりやすいように `auto-scaling-server` という名前をつけた
- 作成が終了したのち、インスタンスをチェックしに行くと新しいインスタンスが2つできてる
