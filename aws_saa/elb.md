# ELB (Elastic Load Balancing)

マネージド型のロードバランシングサービスで、EC2インスタンスの処理を分散する際に標準的に利用する

- インスタンス間の負荷を分散する
- 異常なインスタンスを認識して対応する
  - 例えば止まってるインスタンスがあればそこにトラフィックを回さない
- パブリック、プライベートどちらでも利用可能
- ELB自体も負荷に応じてキャパシティを自動増減するスケーリングを実施
  - スケーリングはAWSが管理するマネージド型サービス
- 従量課金で利用可能
- マネージドサービスなので管理が不要（スケーリングとか）
- Auto Scaling、Route53、Could Formationなどと連携

## ELBの主要機能

- ヘルスチェック
  - EC2インスタンスの正常、異常を確認し、利用するEC2の振り分けを行う
- 負荷分散
  - 配下のEC2の負荷に応じて、複数のAZに跨るEC2インスタンスの負荷分散を行う
- SSLサポート
  - ELBでSSL Terminationできる
- スティッキーセッション
  - セッション中に同じユーザーから来たリクエストを全て同じEC2インスタンスに送信する
- Connecting Draining
  - インスタンスが登録解除されるか異常が発生した場合、そのバックエンドインスタンスへの新規リクエスト送信を中止する
    - インスタンスへのリクエストなどの処理をいきなり止めず、処理が完了するまで待つ。異常時の処理の仕方をコントロールできる
- S3へのログ保管
  - ELBのアクセスログを指定したS3に自動保管

## ELBによるスケーラビリティ

負荷分散によるスケーラビリティとヘルスチェックによる高可用性を実現

- スケーラビリティの確保
  - 複数のEC2インスタンス/ECS Serviceへの負荷分散
    - ひとつのEC2にはトラフィック量30、もうひとつには70といった感じ
- 高可用性
  - 複数のAZの複数のEC2インスタンスのヘルスチェックを行い、止まってしまったら別のインスタンス、ECS Serviceの中から正常なターゲットにのみ振り分けることができる

## ELBのタイプ

現在利用できるロードバランサーは3タイプで、用途に応じて使い分ける

### CLB (Classic Load Balancer)

初期に提供されたELBであり、標準的なL4/L7におけるロードバランシングが可能だが複雑な設定はできない

- HTTP/HTTPSとTCP/SSLプロトコルのL4とL7に対応
- Proxyプロトコルによる発信元IPアドレス識別
- ELBとバックエンドのEC2インスタンス間でHTTPS/SSL使用時にサーバー証明書認証を実施
- CLB配下のインスタンスは、全て同一の機能を持ったインスタンスが必要
- 異なる機能に対してコンテントベースルーティングはできない

### ALB (Application Load Balancer)

レイヤー7の対応が強化された、レイヤー7専用の単一ロードバランサーで、異なるアプリケーションへリクエストをルーティングすることが可能。  
WEBアプリケーション用のロードバランシングとしてはこれを使うことが主流になっている

- URLのパスに基づいてルーティングが可能なパスベースルーティングが可能
  - CLBではできなかった
- WebSocketとHTTP/2のリクエストを受付
- 1インスタンスに複数ポートを登録することが可能
- EC2インスタンスをターゲットグループに割り当てる際、複数ポートを個別のターゲットとして登録することが可能なため、ポートを利用するコンテナをロードバランシング可能
  - ECSといったコンテナもバランシングすることが可能
- ターゲットグループでのヘルスチェックが可能
  - EC2インスタンスをグループしたもの。ターゲットグループにより複雑なトラフィック制御が可能
- アクセスログの情報追加
- EC2と同様に削除保護が可能
- ALB自体が自動的にキャパシティを増減

### CLBとALB

ALBはパスルーティングによりCLBより容易にバランシング構成が可能

- CLBの複数機能バランシング
  - order.japan.com
  - Procure.japan.com
  - それぞれ2つのバランサーを設置する必要がある

- ALBの複数機能バランシング
  - パスルーティングで複数機能のバランシングが可能
  - japan.com/order
  - japan.com/procure
  - 複雑な構成をひとつのバランサーでまかなうことができる

### NLB (Network Load Balancer)

NLBは超低遅延で高スループットを維持しながら秒間何百万リクエストをさばくように設計された最新のロードバランサー。  
ALBを使うのが標準的だが、かなりの大量処理が要求されるケースではNLBを使う

- 開放型システム間相互接続（OSI）モデルの固定IPアドレスを持つL4ロードバランサ
  - ALBはL7に特化していたが、これはL4に特化している
- 揮発性ワークロードを処理し、毎秒何百万のリクエストに対応できる能力
- VPC外のターゲットを含めたIPアドレスや、静的IPアドレスでの登録可能
- 複数ポートで各インスタンス、またはIPアドレスを同ターゲットグループに登録可能
- 大規模アクセスが予測される際にCLBやALBで必須だったPre-warming申請が不要
- ALBやCLBはX-Forwarded-For（XFF）でアクセス元IPアドレスを判断していたが、NLBは送信元アドレスと送信元ポートの書き換えを行わないため、パケットからアクセス元が判断可能
- NLBはフォールトトレランス機能を内蔵したコネクション処理を持ち、数ヶ月から数年のオープンなコネクションを処理できる
  - 『問題が発生した際に、機能や性能を制限することなく、動かし続けるための備え』のこと
- コンテナ化されたアプリケーションのサポート（Dockerとか）
- 各サービスの個別のヘルスステータスのモニタリングのサポート

## ELBによる冗長構成ハンズオンのメモ

- VPCつくる
  - パブリックとプライベートを2つずつ作る予定なので『パブリックとプライベート サブネットを持つVPC』を選択。CIDRアドレスはそのまま
- VPC作ったらサブネットを選択して『サブネットの作成』
  - 作ったVPCを選択、別のAZを選択
- サブネットに対するゲートウェイを作る
  - 作ったパブリックにインターネットゲートウェイをつける
- ルートテーブルにプライベートが関連付けられていないのでプライベート2つを関連付ける
- これで1つのVPCにAZを設置して、それぞれにプライベートとパブリックを設置できたことになる
- S3でバケット作成。 `index.html` を入れておく
- EC2インスタンスを作ってパブリック1aのサブネットに割り当てる
  - 『自動割り当てパブリックIP』を有効にする
  - S3アクセスのIAMロールを割り当て
- bashスクリプトを使用

```bash
#!/bin/bash
# サーバーの設定変更
sed -i 's/^HOSTNAME=[a-zA-Z0-9\.\-]*$/HOSTNAME=udemy-bash/g' /etc/sysconfig/network
hostname 'udemy-bash'
cp /usr/share/zoneinfo/Japan /etc/localtime
sed -i 's|^ZONE=[a-zA-Z0-9\.\-\"]*$|ZONE="Asia/Tokyo"|g' /etc/sysconfig/clock
echo "LANG=ja_JP.UTF-8" > /etc/sysconfig/i18n
# アパッチのインストール
sudo yum update -y
sudo yum install httpd -y
sudo service httpd start
sudo chkconfig httpd on
# index.htmlの設置
aws s3 cp s3://バケット名/index.html /var/www/html
```

- 新しいセキュリティグループ作成、HTTPとHTTPSを追加
- EC2起動
- ターミナルでEC2にアクセス
  - `yum list installed | grep httpd` でApacheがインストールされてるかを確認
  - `cd /var/www/html` でバケットに移動。htmlファイルが有るか確認
  - vimでhtmlに `public-1a` とか追加する
- EC2のコンソールからインスタンスを選択して『イメージの作成』
  - 名前だけ変えて作成。
- 『AMI』から作ったイメージを選択して『起動』
- パブリック1cのサブネットに割り当てる
  - 『自動割り当てパブリックIP』を有効にする
  - S3アクセスのIAMロールを割り当て
- イメージから作った場合は設定がさっきのと同じなのでセキュリティグループまでパス
- 『既存のセキュリティグループ』で上のものを割り当て