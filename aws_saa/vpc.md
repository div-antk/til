# Virtual Private Cloud

- ユーザー専用のプライベートなクラウド環境を提供する
- ネットワーク環境を簡単にカスタマイズできる
- 仮想的な自社専用領域
- 同一リージョン内ではVPCは複数のAZにリソースを含めることができる
- VPCとサブネットの組み合わせでネットワーク空間を構築する
- VPCはサブネットとのセットが必須

## 設定手順

CIDR（サイダー）方式でアドレスストレージを選択 -> AZのサブネットを選択 -> インターネット経路を選択 -> VPCへのトラフィック許可の設定

### IPアドレス

- 3桁（0〜255）×4つの組み合わせで、各桁が8つのバイナリ値の集合を表す

### CIDR (Classless Inter0Domain Routing)

- サブネットマスクの値を設定し、同じネットワークとして扱うIPアドレスの個体を調整できるIPアドレスの設定方法
- 「VPCを設定したら何個IPアドレスを設定できるのか」という設定

`196.51.100.XXX/16`

- 左から16桁目までが同じネットワーク範囲と指定
- 左16桁分が利用できないようにロックされて変更不可となる

`10.0.0.255/16` の場合  
`[00001010].[00000000].0.255/16`

- ロックされていない16桁分のビットの間が有効なIPをアドレスとして活用できる

`10.0.0.255/16` の場合  
`10.0.[00000000].[11111111]/16`

- 最小値

`10.0.0.0`

- 最大値

`10.0.255.255`

- IPアドレスの範囲は今後の拡張も踏まえて十分な余裕がありつつ、多すぎないレンジを指定する

16で設定するのが無難  
`10.0.0.255/16（推奨レンジ[65,534アドレス]）`

- VPCは /16~/28 のCIDR範囲を使用できる
- すでに利用されているなどして設定できないアドレスもある（/24の場合）↓

| ホストアドレス | 用途                   |
| ------- | -------------------- |
| .0      | ネットワークアドレス           |
| .1      | VPCルータ               |
| .2      | Amazonが提供しているDNSサービス |
| .3      | AWSで予約されているアドレス      |
| .255    | ブロードキャストアドレス         |

### サブネット

- 大きなネットワークの中の小さなネットワークのこと
- 1つの大きなネットワークを管理するのは大変なので、複数の小さなネットワークの集まりとして管理する
- CIDR範囲で分割したネットワークセグメント
- VPC内のネットワークのセグメント
- 大きく分けて2つある
- サブネットはVPC内に複数設置でき、プライベートとパブリックに分かれる
- 使い分けて複数設定していくのが設計のやり方になる
- **パブリックとプライベートのインターネットアクセス範囲を定義するために利用する**
- パブリックにはインターネットと接続が必要なリソースを揃える
- プライベートにはインターネットから隔離することでセキュリティを高める

#### パブリックサブネット

- トラフィックがインターネットゲートウェイにルーティングされる
- インターネットの出入り口があり、インターネットに接続できる

#### プライベートサブネット

- トラフィックがインターネットゲートウェイがない
- 外の世界と接続できない
- インターネットに接続するにはNATゲートウェイがパブリックサブネットに必要（一旦中継することになる）

### VPCにサブネットを設定

- VPCにCIDR/16を設定し、サブネットに/24の設定を推奨されている

### VPC外部接続

- VPCの外側にあるリソースとの通信にはパブリックのAWSネットワークかエンドポイントを利用する
- パブリックのAWSネットワークを利用してEC2に接続、エンドポイントを利用してS3に接続といった感じ

### インターネット経路を設定

- ルートテーブルとCIDRアドレスでルーティングを設定する
- ルートテーブルでパケットの行き先を設定
- VPC作成時にデフォルトで1つのルートテーブルを作成
- VPC内はCIDRアドレスでルーティング

### VPCトラフィック設定

- トラフィック設定はセキュリティグループ、またはネットワークACL（アクセスコントロールリスト）を利用する
- ACL（アクセス制御リスト）とは、ファイルやフォルダ、ネットワークなどに対するアクセス権がまとめて書いてある一覧のこと
- ネットワークACLはサブネットに適用され、セキュリティグループはEC2などのインスタンスにセットされる

#### セキュリティグループ設定

- ステートフル（戻りトラフィックの考慮がいらない）
- サーバー単位で適用
- 許可のみをIn/Outで指定
- デフォルトでは同じセキュリティグループ内通信のみ許可
- 必要な通信は許可設定が必要
- すべてのルールを適用

#### ネットワークACLs設定

- ステートレス（戻りトラフィックも許可設定が必要）
- サブネット単位で適用
- 許可と拒否をIn/Outで指定
- デフォルトではすべての送信元IPを許可
- 番号の順番通りに適用

## VPC設計ポイント

- 設計時には将来の拡張も見据えたアドレッシングや、他ネットワークとの接続性も考慮する
- CIDR（IPアドレス）は既存のVPC、社内のDC（データセンター）やオフィスと被らないアドレス帯を設定し、組織構成やシステム構成の将来像も考えながら前もって計画する（適当に設定しない。将来どこまで大きくなるかなども考慮）
- VPC構成は自社業務に合わせたVPC単位ではなく、VPC全体の関係性も視野に入れる
- 組織とシステム境界からVPCをどのように分割するか、将来構成も考慮して検討する
- 複数AZを利用して可用性の高いシステムを構築
- サブネットは大きいサブネットを使い、パブリック/プライベートサブネットへのリソースの配置をインターネットアクセス可否から検討する
- セキュリティグループを使ってリソース間のトラフィックを適切に制御する
- 実装や運用を補助するツールも有効利用し、VPC Flow Logs（モニタリングツール）を使ってモニタリングできるようにする

## VPCとの接続

### VPCとのオンプレミス接続

#### VPN（Virtual Private Network）接続

#### 専用線接続（Direct connect）

- お客様のDCやオフィスを専用線などを介してAWSへプライベートに接続するサービス
- Direct Connectロケーションに物理的に自社オンプレ環境を接続することで、AWS環境とも専用線接続を実現する

`プライベートサブネット - DirectConnectデバイス - 自社機器 - Gateway - 自社オンプレ環境`

- メリット
  - 信頼性が高い
  - 安価なアウトバウンドトラフィック料金
  - ネットワーク信頼性の向上
  - ネットワーク帯域幅の向上

#### Direct Connect Gateway

- 同一アカウントに所属する複数リージョンの複数AZから、複数リージョンの複数VPCに接続

東京リージョン -> DirectConnect -> 米国東部と中国香港リージョンなど

## VPNとのDirect Connect

- VPNのほうが安く素早く利用できるが、信頼性や品質は専用線が勝る

|        | VPN                            | 専用線                   |
| ------ | ------------------------------ | --------------------- |
| コスト    | 安価なベストエフォート回線が利用可能             | キャリアの専用線サービス契約が必要で割高  |
| リードタイム | クラウド上での接続設定で可能なため即時            | 物理対応が必要なため数週間         |
| 帯域幅    | 暗号化のオーバーヘッドにより制限がある            | ポートあたり1G/10Gbps       |
| 品質     | ネット経由のためネットの状態の影響を受ける          | キャリアにより高い品質が保証される     |
| 障害切り分け | ネットベースのため、自社で保持して管理している範囲以外の確認は難しい | 物理的に経路が確保されているため比較的安易 |

## VPCエンドポイント

- グローバルIPを持つAWSサービスに対して、VPC内から直接アクセスするための出口  
- VPCの外にあるリソースにインターネットを介さずにアクセスすること

VPCの外にあるS3にアクセスする場合  
`VPC（パブリックサブネット[EC2]） -> VPCエンドポイント -> S3`

- 2種類の接続方法がある。用途に応じて2つのやり方を検討する

### Gateway型

- サブネットに特殊なルーティングを設定し、VPC内部から直接外のサービスを通信する  

`VPC（サブネット[EC2]） -> ルートテーブル（172.16.0.0など） -> VPCエンドポイント（VPCE-9j9kh9） -> S3`

VPCエンドポイントでエンドポイントポリシーを作って制御

- 特徴
  - アクセス制御: エンドポイントポリシーを設定
  - 料金: 無料
  - 冗長性: AWS側が対応（マネージド型サービス）

### PrivateLink型

- サブネットにエンドポイント用のプライベートIPアドレスを生成し、DNSが名前解決でルーティングする

`VPC（サブネット[EC2]） -> ルートテーブル -> VPCエンドポイント（10.0.0.100） -> S3`

- サブネットにエンドポイント用のプライベートIPアドレスが発生してDNSが名前ルーティングで返し、それを介してS3に接続する
- 通常のIPアドレスがVPCエンドポイントにも付与されるというやり方

- 特徴
  - アクセス制御: セキュリティグループを設定
  - 料金: 有料
  - 冗長性: マルチAZ設計

## NATゲートウェイ (Network Address Translation)

- NATとは、グローバルIPアドレスとプライベートIPアドレスを紐付けて変換する技術
- プライベートサブネットのリソースがインターネットまたはAWSクラウドと通信が可能になる
- プライベートサブネットは基本的にインターネットに接続できないが、NATゲートウェイを使うことで初めて可能になる  

`VPC（プライベートサブネット[EC2]） -> NATゲートウェイ -> クラウド`

- 特徴
  - AWSによるマネージドNATサービス
  - EIPの割当が可能
  - 最大10Gbpsの高パフォーマンス
  - ビルトインで冗長化されている高可用性
  - アベイラビリティゾーンごとに設置する

## VPC Flow logs

- ネットワークトラフィックを取得し、CloudWatchでモニタリングできるようにする機能
- ネットワークインターフェイスを送信元/送信先とするトラフィックが対象
- セキュリティグループとネットワークACL（アクセスコントロールリスト）のルールでaccepted/rejectされたトラフィックログを取得
- キャプチャウインドウと言われる時間枠（約10分間）で収集、プロセッシング、保存する
- RDS、Redshift、ElasticCache、WorkSpacesのネットワークインターフェイストラフィックも取得可能
- 追加料金なし

## VPCの設定上限

- 各種設定においては上限数があるため、大規模に利用する場合は考慮する必要がある

| リソース                           | 数   |
| ------------------------------ | --- |
| リージョンあたりのVPCの上限数               | 5   |
| VPCあたりのサブネットの上限数               | 200 |
| AWSアカウントあたりの1リージョン内のElasticIP数 | 5   |
| ルートテーブルあたりのルート上限数              | 100 |
| VPCあたりのセキュリティグループの上限数          | 500 |
| セキュリティグループあたりのルールの上限数          | 50  |

## VPCを分割するケース

- アプリサービスや組織構成などの用途に応じてVPCを分割する
- アプリケーションによってVPCを分ける
- 監視のスコープによる分割
- リスクが高いものを別のVPCに分ける
- 本番、検証、開発フェーズによる分割
- 部署による分割、共通サービスの切り出し

## VPC Peering

- VPC間の接続
- 2つのVPC間でのトラフィックルーティングが可能
- 異なるAWSアカウント間のVPC間をピア接続可能
- 一部のリージョン間の異なるVPC間のピア接続も可能
- 単一障害点や帯域幅のボトルネックは存在しない

## VPCの設計（シンプルな）

- パブリックサブネットとプライベートサブネットを作る
- パブリックにWEBサーバー、プライベートにDBサーバーを立てる
- セキュリティグループとルートテーブルで設定し、それぞれのインスタンスのアクセス、トラフィックを制御する
- NATゲートウェイを設置してプライベートサブネットからインターネットのアクセスを可能にする
- ネットワークACLによりアクセス制御を追加する
- エンドポイントを設置してプライベートサブネットからS3に接続する

## VPCとサブネットを設置する

1. 新しいVPCを設置する
2. VPC内の2つのAZにサブネットを一個ずつ設置する
3. サブネットをプライベートとパブリックに設定する

- 『VPCの作成』
  - 名前、CIDRの設定 `10.0.0.0/16`
  - デフォルト
- 『サブネットの作成（パブリック用）』
  - 上で作ったVPCをアタッチ
  - 名前はアベイラビリティゾーンの名前の語尾「1a」と紐づくようなわかりやすい名前をつける
  - CIDRは `10.0.5.0/24`
- 『サブネットの作成（プライベート用）』
  - 上で作ったVPCをアタッチ
  - 名前はアベイラビリティゾーンの名前の語尾「1c」と紐づくようなわかりやすい名前をつける
  - CIDRは `10.0.10.0/24`
- 『インターネットゲートウェイの作成』
  - 作ったら『VPCにアタッチ』で、作ったVPCにアタッチしてインターネットに接続できるようにする
- 『ルートテーブルの作成』
  - 作ったルートテーブルで『ルートの編集』
  - 『ルートの追加』でフルオープンの `0.0.0.0/0`
  - ターゲットで『Internet Gateway』を選択
- 作ったルートに対してパブリックサブネットを設定する
  - 『サブネットの関連付け』で `10.0.5.0/24` を選択して保存
- パブリックの方に『アクション』から『IPv4の自動割り当て』を有効にする

## VPC/サブネットにサーバーを設置する

1. パブリックサブネットにWEBサーバーを設置
2. プライベートサブネットにDBサーバーを設置
3. 2つのサーバーが通信できるように設定する
4. プライベートサブネット内のDBサーバーからインターネットに通信できるようにNATゲートウェイを設置する

- パブリック用のEC2を作る
  - ステップ3までデフォルトでいく
    - 『ネットワーク』を上で作ったVPCに設定
    - 『サブネット』を上で作ったパブリックのものに設定
  - 『終了保護』と『モニタリング』にチェックを入れておく
  - ステップ5で名前をつける。ステップ6でHTTPとHTTPSを追加
- プライベート用のEC2を作る
  - ステップ3までデフォルトでいく
    - 『ネットワーク』を上で作ったVPCに設定
    - 『サブネット』を上で作ったプライベートのものに設定
  - 『終了保護』と『モニタリング』にチェックを入れておく
- ステップ5で名前をつける。ステップ6でHTTPとHTTPSを追加
- ターミナルでパブリックのEC2にssh接続
  - `sudo su`  
  - `yum update -y`  
  - `yum install -y httpd`  
- プライベートのセキュリティグループを差し替える
  - 『セキュリティグループの作成』
    - 名前と説明（同じでいい）、VPCは作ったものを選択、ルールにSSH、HTTP、HTTPS、MySQL、『すべてのICMP』を追加
    - 『ソース』でIPアドレスをパブリックのアドレス（`10.0.5.0/24`）に限定することによってパブリック側からのアクセスのみを許可する
    - アドレスではなくパブリックの『セキュリティグループID』でもいける
  - プライベートのEC2インスタンスを選択して、アクションの『ネットワーキング』から作ったセキュリティグループに変更
- ターミナルでプライベートの『プライベートIP』を飛ばして確認
  - `ping 10.0.0.XXX`
  - `ping` とは対象のコンピュータとネットワークでつながっているか確認するときに使うコマンド
- プライベート側のEC2に入る設定をパブリック側のEC2で設定する。ターミナルで作業
  - `vi myprivatekey.pem`
    - pemから内容をコピペ
  - `chmod 400 myprivatekey.pem`
    - 400とは所有者が読み取り権限だけ付与の意味
  - `ssh ec2-user@プライベート側のIPアドレス -i myprivatekey.pem`
    - これでプライベート側のEC2に入れる
- `sudo su` から `yum update -y` をやっても失敗する。NATゲートウェイを設ける必要がある
- NATゲートウェイはパブリック側に設定する必要がある。コンソールからVPCに行って設定する

- パブリック側の『サブネットID』をコピーする
- 『NATゲートウェイ』から作成する
  - 『サブネット』にコピーしたIDを貼り付け（探しにくいため）
  - ElasticIPが必要なため『新しいEIPの作成』
- **NATゲートウェイの置き場所はパブリック側だが、それを利用するのはプライベートのサブネットであるため**、プライベート側のルートテーブルにNATゲートウェイを設定する
- 『ルートテーブル』からだと探しづらいので『サブネット』からルートテーブルIDをクリックする
- 『ルートの編集』
  - 『送信先』はフルオープンの `0.0.0.0/0`
  - 『ターゲット』でNATゲートウェイを選択
- ターミナルに戻り、あらためて `yum update -y`
- `yum install -y mysql`
  これによってデータベースサーバにすることができた
- NATゲートウェイは従量課金制である

## ネットワークACL

- ネットワークACLによるアクセス制御を追加する
- 『VPC』から『ネットワークACL』で『ネットワークACLの作成』
- 作成するとすべてのルールが `DENY` で作られている
- 試しにパブリック側のEC2のApache内でhtmlを作ると現時点では表示される
- 作ったネットワークACLのインバウンドルールの編集
  - 100 SSH
  - 200 HTTP
  - 300 HTTPS
- 作ったネットワークACLのアウトバウンドルールの編集
  - 100 HTTP
  - 200 HTTPS
  - 300 カスタムTCPルール ポート番号（`1024-65535`）
    - 個々のPCによって固定のポート番号が割り当てられてるわけではない（エフェメラルポート）ので広く設定しておく必要がある
- 『サブネットの関連付けの設定』
  - 2つのサブネットIDを選択

### アクセスを特定のURLからできないような設定をする

- インバウンドルールの100をHTTPに変更
- 自身のグローバルIPアドレスを確認（方法はググる）
- インバウンドルールに追加
  - 101 HTTP 送信元 `グローバルIP/32` DENY
- この時点ではまだ拒否されない。上の方の『許可する』のルールから適応されるため
  - なので設定した 101 を 99 にしてあげると100（許可するルール）より前に適応されるためアクセスができなくなる

## VPCエンドポイントを使ってS3にアクセスする

- ネットワークACLによるアクセス制御を追加する
- IAMロールを作ってEC2からS3にアクセスできる状態にする
