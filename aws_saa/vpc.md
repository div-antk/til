# Virtual Private Cloud

- ユーザー専用のプライベートなクラウド環境を提供する
- ネットワーク環境を簡単にカスタマイズできる
- 仮想的な自社専用領域
- 同一リージョン内ではVPCは複数のAZにリソースを含めることができる
- VPCとサブネットの組み合わせでネットワーク空間を構築する
- VPCはサブネットとのセットが必須

## 設定手順

CIDR（サイダー）方式でアドレスストレージを選択 -> AZのサブネットを選択 -> インターネット経路を選択 -> VPCへのトラフィック許可の設定

### IPアドレス

- 3桁（0〜255）×4つの組み合わせで、各桁が8つのバイナリ値の集合を表す

### CIDR (Classless Inter0Domain Routing)

- サブネットマスクの値を設定し、同じネットワークとして扱うIPアドレスの個体を調整できるIPアドレスの設定方法
- 「VPCを設定したら何個IPアドレスを設定できるのか」という設定

`196.51.100.XXX/16`

- 左から16桁目までが同じネットワーク範囲と指定
- 左16桁分が利用できないようにロックされて変更不可となる

`10.0.0.255/16` の場合  
`[00001010].[00000000].0.255/16`

- ロックされていない16桁分のビットの間が有効なIPをアドレスとして活用できる

`10.0.0.255/16` の場合  
`10.0.[00000000].[11111111]/16`

- 最小値

`10.0.0.0`

- 最大値

`10.0.255.255`

- IPアドレスの範囲は今後の拡張も踏まえて十分な余裕がありつつ、多すぎないレンジを指定する

16で設定するのが無難  
`10.0.0.255/16（推奨レンジ[65,534アドレス]）`

- VPCは /16~/28 のCIDR範囲を使用できる
- すでに利用されているなどして設定できないアドレスもある（/24の場合）↓

| ホストアドレス | 用途                   |
| ------- | -------------------- |
| .0      | ネットワークアドレス           |
| .1      | VPCルータ               |
| .2      | Amazonが提供しているDNSサービス |
| .3      | AWSで予約されているアドレス      |
| .255    | ブロードキャストアドレス         |
|         |                      |

### サブネット

- 大きなネットワークの中の小さなネットワークのこと
- 1つの大きなネットワークを管理するのは大変なので、複数の小さなネットワークの集まりとして管理する
- CIDR範囲で分割したネットワークセグメント
- VPC内のネットワークのセグメント
- 大きく分けて2つある
- サブネットはVPC内に複数設置でき、プライベートとパブリックに分かれる
- 使い分けて複数設定していくのが設計のやり方になる
- **パブリックとプライベートのインターネットアクセス範囲を定義するために利用する**
- パブリックにはインターネットと接続が必要なリソースを揃える
- プライベートにはインターネットから隔離することでセキュリティを高める

#### パブリックサブネット

- トラフィックがインターネットゲートウェイにルーティングされる
- インターネットの出入り口があり、インターネットに接続できる

#### プライベートサブネット

- トラフィックがインターネットゲートウェイがない
- 外の世界と接続できない
- インターネットに接続するにはNATゲートウェイがパブリックサブネットに必要（一旦中継することになる）

### VPCにサブネットを設定

- VPCにCIDR/16を設定し、サブネットに/24の設定を推奨されている

### VPC外部接続

- VPCの外側にあるリソースとの通信にはパブリックのAWSネットワークかエンドポイントを利用する
- パブリックのAWSネットワークを利用してEC2に接続、エンドポイントを利用してS3に接続といった感じ

### インターネット経路を設定

- ルートテーブルとCIDRアドレスでルーティングを設定する
- ルートテーブルでパケットの行き先を設定
- VPC作成時にデフォルトで1つのルートテーブルを作成
- VPC内はCIDRアドレスでルーティング

### VPCトラフィック設定

- トラフィック設定はセキュリティグループ、またはネットワークACL（アクセスコントロールリスト）を利用する
- ACL（アクセス制御リスト）とは、ファイルやフォルダ、ネットワークなどに対するアクセス権がまとめて書いてある一覧のこと
- ネットワークACLはサブネットに適用され、セキュリティグループはEC2などのインスタンスにセットされる

#### セキュリティグループ設定

- ステートフル（戻りトラフィックの考慮がいらない）
- サーバー単位で適用
- 許可のみをIn/Outで指定
- デフォルトでは同じセキュリティグループ内通信のみ許可
- 必要な通信は許可設定が必要
- すべてのルールを適用

#### ネットワークACLs設定

- ステートレス（戻りトラフィックも許可設定が必要）
- サブネット単位で適用
- 許可と拒否をIn/Outで指定
- デフォルトではすべての送信元IPを許可
- 番号の順番通りに適用

## VPC設計ポイント

- 設計時には将来の拡張も見据えたアドレッシングや、他ネットワークとの接続性も考慮する
- CIDR（IPアドレス）は既存のVPC、社内のDC（データセンター）やオフィスと被らないアドレス帯を設定し、組織構成やシステム構成の将来像も考えながら前もって計画する（適当に設定しない。将来どこまで大きくなるかなども考慮）
- VPC構成は自社業務に合わせたVPC単位ではなく、VPC全体の関係性も視野に入れる
- 組織とシステム境界からVPCをどのように分割するか、将来構成も考慮して検討する
- 複数AZを利用して可用性の高いシステムを構築
- サブネットは大きいサブネットを使い、パブリック/プライベートサブネットへのリソースの配置をインターネットアクセス可否から検討する
- セキュリティグループを使ってリソース間のトラフィックを適切に制御する
- 実装や運用を補助するツールも有効利用し、VPC Flow Logs（モニタリングツール）を使ってモニタリングできるようにする

## VPCとの接続

### VPCとのオンプレミス接続

#### VPN（Virtual Private Network）接続

#### 専用線接続（Direct connect）

- お客様のDCやオフィスを専用線などを介してAWSへプライベートに接続するサービス
- Direct Connectロケーションに物理的に自社オンプレ環境を接続することで、AWS環境とも専用線接続を実現する

`プライベートサブネット - DirectConnectデバイス - 自社機器 - Gateway - 自社オンプレ環境`

- メリット
  - 信頼性が高い
  - 安価なアウトバウンドトラフィック料金
  - ネットワーク信頼性の向上
  - ネットワーク帯域幅の向上