# S3 (Simple Storage Service)

- ユーザがデータを容量制限なく保存可能なマネージド型で提供されるオブジェクト型ストレージ
- 無制限にいくらでも容量を増やせる

| 特徴            |                                  |
| ------------- | -------------------------------- |
| 高い耐久性         | 99.99999999999%（イレブンナイン）         |
| 安価なストレージ      | 容量単価: 月額1GB / 約3円                |
| スケーラブルで安定した性能 | 冗長化されて保存され、データ容量に依存しない性能がAWS側で保証 |
| 暗号化           | 転送中や保存時にデータを暗号化可能                |

| データ保存形式 |                                        |
| ------- | -------------------------------------- |
| バケット    | オブジェクトの保存場所。名前はグローバルでユニークな必要がある        |
| オブジェクト  | S3に格納されるファイルでURLが付与される。バケット内オブジェクトは無制限 |
| データサイズ  | 0KB ~ 5TB                              |

- AWSには3つのストレージサービスがある

## ブロックストレージ

- EC2にアタッチして活用するディスクサービス
- ブロック形式でデータを保存
- 高速、広帯域幅
- 例: EBS、インスタンスストア

## オブジェクトストレージ

- 安価かつ高い耐久性を持つオンラインストレージ
- オブジェクト形式でデータを保存
- 安くデータを大量に保存する場合に向いている
- 例: S3、Glacier（S3よりさらに安い）

## ファイルストレージ

- 複数のEC2インスタンスから同時にアタッチ可能な共有ストレージサービス
- ファイル形式でデータを保存
- 例: EFS

## S3のオブジェクト構成

- Key
  - オブジェクトの名前であり、バケット内のオブジェクトは一位に識別する
- Value
  - データそのものであり、バイト値で構成される
- バージョンID
  - バージョン管理に用いるID
  - 変更したり削除したりするとIDが振られる（IDを有効化してるときのみ）
  - 削除してもバージョンを残すことができる
- メタデータ
  - オブジェクトに付随する属性の情報
- サブリソース
  - バケット構成情報を保存、および管理するためのサポートを提供
  - 例: アクセス制御リスト（ACL）

## S3のデータ構成

- バケット単位で保存スペースを区分し、オブジェクトでデータを格納する
- 例↓

S3 -> バケット（website-bucket） -> オブジェクト（html、csv）  
->バケット（contents-bucket） -> オブジェクト（mp3、jpeg）

## AWSストレージサービス

- 値段や性能で最適なものを選ぶのがコツ

| タイプ                             | 特徴                                                                      | 耐久性             | 可用性    |
| ------------------------------- | ----------------------------------------------------------------------- | --------------- | ------ |
| STANDARD                        | 複数箇所にデータを複製するため耐久性が非常に高い。基本的に一番値段が高い                                    | 99.99999999999% | 99.99% |
| STANDARD-IA                     | 低頻度アクセスストレージ。スタンダードに比べて安価。データの読み出し容量に応じた課金                                           | 99.99999999999% | 99.9% |
| One Zone-IA                     | IAとの違いは、複数AZに分かれていないので可用性が落ちる。あまり重要ではないデータ向け。アクセス頻度は低いが、必要に応じてすぐに取り出すデータ向け                                           | 99.99999999999% | 99.95% |
| RRS (Reduced Redundancy Strage) | 低冗長化ストレージ。まだ使われているが非推奨されている。特に更新されていないので値段が実質高いまま。以前はGlacierから取り出したデータ配置などに使われていた                                         | 99.99%          | 99.99% |
| Amazon Glacier                  | 最安のアーカイブ用ストレージ。データ抽出にコストと時間（3~5時間）を要する。値段が圧倒的に安い（性能が低い）。中長期で使わないものの保管など。ライフサイクルマネジメントで指定。ボールロック機能でデータを保持 | 99.99999999999% | N/A    |

- S3 Intelligent-Tieringというものもある
  - 機械学習でアクセス頻度などを見て最適なストレージを選択する

## S3の整合性モデル

- S3は高い可用性を実現するため、データ更新、削除には結果整合性モデルを採用。同時書き込みはタイムスタンプ処理を実施
- 同時にアクセスしたり更新したり削除したりする場合の整合性

| データ処理 | 整合性モデル                    |
| ----- | ------------------------- |
| 新規登録  | Consistency Read          |
|       | 登録後即時にデータが反映される           |
| 更新    | Eventual Consistency Read |
|       | 更新直後はデータ反映に時間がかかる         |
| 削除    | Eventual Consistency Read |
|       | 削除直後はデータ反映に時間がかかる         |

## S3のアクセス管理

- S3のアクセス管理は用途に応じて方針を使い分ける

| 管理方法        | 特徴                                         |
| ----------- | ------------------------------------------ |
| IAMユーザーポリシー | IAMユーザーに対してアクセス権限を設定                       |
|             | 一元的にユーザー権限を管理                              |
|             | 一番良く使う                                     |
| バケットポリシー    | バケット、オブジェクトのアクセス権をJSONで設定                  |
|             | クロスアカウントでのアクセス権限管理を実施するケース向け               |
| ACL         | バケットとオブジェクトへのアクセス権限をXMLで設定（したがって細かく設定できる）  |
|             | アクセス権限リストを使って設定する                          |
|             | 簡易的に権限管理を実施                                |
| 署名付きURL     | AWS SDKで生成した署名付きURLで3Sのオブジェクトへの一定時間アクセスを許可 |

## S3の暗号化

- S3へのデータ保管時の暗号化形式は2つ
- データの転送時と保存時に暗号化する

| 暗号化方式        | 特徴                                                     |
| ------------ | ------------------------------------------------------ |
| サーバーサイド暗号化   | AWSのサーバーリソースを利用して格納データの暗号化を実施                          |
|              | 暗号化タイプ: SSE-S3 / SSE-KMS / SSE-C                       |
| クライアントサイド暗号化 | 暗号化プロセスをユーザ側で管理する                                      |
|              | 暗号化タイプ: AWS KMSで管理されたカスタマーキーで暗号化、クライアントが管理するマスターキーで暗号化 |

## レプリケーション（レプリカを作ること）

- リージョン間を跨ぐクロスリージョンレプリケーションにより耐障害性を高める
- リージョン間を跨ぐというのはAWSのサービスでもなかなかできない
- これによってBCP（事業継続計画）に役立つ

### レプリケーションのトリガー

- バケットに対するオブジェクト作成、更新、削除をトリガーにレプリケーションを実行する

### 設定

- バージョニング機能を有効にする
  - ライフサイクル管理によって保存する期間の指定もできる
  - バケット削除時に古いバージョンの別途削除が必要
- バケットは各別リージョンを指定
- 双方向レプリケーションも可能
- データ転送費が発生

## ライフサイクル管理

- バケット内のオブジェクト単位でストレージクラスの変更や削除時期などを設定することで実行を自動化する
- 一定時間で自動アーカイブ
  - S3 (Standard) -> Glacier
- 一定時間で安価な保存場所へ
  - S3 (Standard) -> S3 (Standard-IA)
- 一定時間で自動的に削除
  - S3 (Standard) -> 削除

### 設定方法

- バケット全体やPrefixに設定
- オブジェクト更新日を基準にして日単位で指定し、毎日0:00UTCにキューを実行
- 最大1,000ルール
- IAに移動できるのは128KB以上のオブジェクト
- MFA（多要素認証） Deleteが有効だと設定不可なので注意が必要

## バックアップ

- Glacierを利用してバックアップと復元が実施可能

### アーカイブ

- S3オブジェクトデータをGlacierに移動
- S3データを削除するとGlacier側も削除される
- データ紐付け
  - S3: 8KBオブジェクト / メタデータ
  - Glacier: 32KBオブジェクト / メタデータ
  - バックアップデータとバックアップ元が関連付けられている

### リストア

- オブジェクトごとに復元が可能
- 一時的にRRSに指定日数間複製する
- 復元に要する時間を選択
- 復元期間はRRSとGlacierで課金

## 利用状況をどう確認するのか（モニタリング）

- S3の利用状況やS3のイベント発生を確認することができる

### S3の分析

- データのアクセスパターンの簡易可視化
- CSV形式での出力可能
- バケット内のデータの扱い方の分析を実施
- アクセス頻度の低いデータや保存期間を確認して、ライフサイクルポリシー設定に活かしていく

### S3のイベント通知

- バケット内イベントの発生をトリガーにして、SNS、SQS、Lambda（他のS3サービス）に通知設定が可能
- シームレスなシステム連携処理を実現

## S3の用途

- 大量データを長期保存するという観点から用途を検討する。
- コンテンツ配信、保管
  - シンプルでよく使われる
  - クライアント -> CloudFront -> S3 <- CMS（画像など）
- ログ、バッチの保管場所
  - クライアント -> EC2 -> DB <- バッチ処理でDB更新 <- S3（バッチファイルの保存）
- バックアップ、ディザスタリカバリ（災害発生時の対策）
  - EC2からS3にAWS環境バックアップし、別リージョンのS3にクロスリージョンで複製保持
  - もしくはオンプレミス環境からS3にバックアップし、別リージョンの（略）
- WEBの静的ホスティング
  - S3のみで静的なWEBサイトをホスティングして構築可能
    - マネジメントコンソールでバケット単位で指定
    - 独自ドメインをバケット名として指定
    - 任意のドメインへのリダイレクト機能
    - 異なるドメインからのアクセス時にCOPS（Cross-origin Resource Sharing）を利用
    - CloudFrontとの連携（経由での配信処理を推奨）で高速で素材を処理する
- データレイク
  - IOTなどのビックデータ処理
  - S3やGlacierと組み合わせて使う

## S3バケットの作成

- バケットの新規作成。パブリックアクセスブロックのチェックはそのまま
  - 『管理』からあとで変更することもできる
- データのアップロード。今回はすべて『次へ』でアップロードした
  - アップロードしたファイルをチェックすると『オブジェクトURL』がある
  - しかしクリックするとエラーが表示される。パブリックアクセスブロックしてるため
  - バケットの『アクセス権限』のチェックを外す
  - ファイルをチェックして『アクション』から『公開する』を選ぶ
  - 再度URLにアクセスするとファイルが見られる

## S3のバージョン管理

- バケットの『プロパティ』から『バージョニング』で有効化する
  - 一度有効化すると『停止』しかできなくなる（無効化できない）ので注意
- テスト用にテキストファイルをアップロード
  - URLをクリックしても見ることができない。毎回公開設定をする必要がある
- 内容をいじった上記ファイルを再アップロード
- バケットの『バージョン』から『表示』を選ぶとバージョンが見られる
- ファイルを削除してみる。削除した場合も新しいバージョンが作られる
- ファイルを削除したバージョンにチェックを入れて『削除』を選択するとファイルが復活する

## S3のライフサイクル管理

1. S3の管理項目を確認
2. インベントリの設定
3. ライフサイクルルールの設定

- Trailで設定したS3を使うが削除してしまっていたため今回はパス
- 「30日経ったらIAに移動」さらに「60日経ったらGlacierに移動」といった設定をする
- 『失効』の設定で「300日経ったら以前のバージョンを削除するといった設定」をする
- また『失効』の設定で、大きいデータをアップロードしようとするといくつかのパートに分けてアップロードされる。途中で失敗するとパートが残ってしまうので数日経ったら削除するように設定する（教材では7日）

## EC2からのS3ファイルの取得

1. S3にHTMLファイルを保存をする
2. 新規にEC2インスタンスを立ち上げる
3. S3内のファイルをコピーしてWEBページを設定する
4. WEBページを確認する

- 適当なhtmlファイルを作る
- インスタンスを作る（以前のbashスクリプトを使用）
- S3にアクセスするIAMロールを割当する
- ターミナルからEC2にアクセス。
  - `sudo su` -> `aws s3 ls` でS3と接続できているか確認
- S3において `udemytest20200619/test.html` のディレクトリ階層がある
- `aws s3 cp s3://udemytest20200619/test.html /var/www/html` でコピーを実行する
  - が、`html` というディレクトリが作られずうまくいかなかったのであらかじめ `mkdir /var/www/html` しておく

## リージョン間を跨いだレプリケーション

1. シンガポールリージョンにバケットを作成
2. レプリケーションの設定
3. CLIを使ったレプリケーションの実行
4. ファイル更新による自動レプリケーションを確認

- レプリケーションをするためのバケットを作る
  - 別リージョンに作る（シンガポール）。他の設定はそのまま
- レプリケーション元のバケットを選択して『管理』から『レプリケーション』
  - バージョン管理の設定がされていないとエラーが出る
  - データが保存されているオブジェクトが変更されるとバージョンIDが発行される。それを使ってバージョンが変わったことがトリガーになっているため
- すべてのコンテンツをレプリケーションするか、自分で設定したタグのみをレプリケーションするかが選択できる（今回はすべて）
- 送信先のバケットを選ぶ（シンガポールリージョンのやつ）
- ストレージクラスを選ぶ（今回はGlacier）
- IAMロールで『新しいロールを作成』と『ルール名』を決めて作成
- レプリケーションはデータが変更されたりすることをトリガーに行われるが、すでに入っているデータに対してレプリケーションは行われないので、CLIでデータをコピーする必要がある
  - `aws s3 cp s3://元バケット名 s3://レプリケーション先バケット名`
- レプリケーション元にファイルをアップロードしてみるとレプリケーション先にもファイルがアップされているのがわかる

## 静的ホスティングの活用

1. 専用のバケットを作る
2. 静的ホスティングの設定
3. バケットポリシーの設定
4. WEBページをアップロードして確認

- バケット作る。パブリックアクセスブロックはすべて解除
- 『プロパティ』から『Static website hosting』
  - 「このバケットを使用してウェブサイトをホストする」
  - 『インデックスドキュメント』で `index.html` を入力
- 『アクセス権限』の『バケットポリシー』に以下を入力

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "PublicReadForGetBucketObjects",
            "Effect": "Allow",
            "Principal": "*",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::バケット名/*"
        }
    ]
}
```

- `index.html` をアップロードする
- 『プロパティ』の『Static website hosting』のエンドポイントのリンクをクリックすると表示される

## S3のプロパティ活用

### サーバーアクセスのログ記録

- 有効化してログをためておくことが可能

### デフォルト暗号化

- オブジェクトにデフォルトで暗号化しておくかどうか
- S3で管理しているキーか、KMS（別サービス）で管理しているキーかを選べる

## S3の外部接続

### AWS Strage Gateway

- オンプレミスとつなげるサービス
- 標準的なストレージプロトコルを利用して、外部システム環境とAWSのストレージサービスを接続するサービス
- オンプレからS3にバックアップを置いていきたいといったことが可能になる
  - 東京リージョン（S3、EC2） <- オンプレミス環境

#### メリット

- 標準的なストレージプロトコルを活用したシームレスな統合
- キャッシュを活用した低レイテンシ（時間）なアクセスが可能
- AWSストレージサービスの堅牢性、低コスト、拡張性
- 効率的なデータ転送
- AWSのモニタリング、管理、セキュリティとの統合

#### 用途

- データ転送や保存など、AWSストレージを利用したい場合に用いる
  - ビッグデータ処理、クラウドバースティング、システム移行のため
  - バックアップ、アーカイブ、災害対策（事業継続性計画）として
  - オンプレ環境で用意にAWSストレージを活用

#### Strage Gatewayのタイプ

利用するデータタイプに応じて3つのゲートウェイを利用する

##### ファイルゲートウェイ

- S3オブジェクトにStrage Gatewayを利用してファイルデータを格納
- オンプレミスのファイルデータをStrage Gateway経由でS3に上のオブジェクトとして格納
- 仮想アプライアンスでNEF v3 / v4.1のインターフェイスを提供
- 更新データは非同期でAWSに転送
- ファイルとオブジェクトのマッピングは1対1
- S3のライフサイクルポリシー、バージョニング、クロスリージョンレプリケーションなどが利用可能

##### ボリュームゲートウェイ

- 長期の保管やDisaster Recoveryを想定する場合にはこちらを使うのが標準的
- S3およびEBS snapshotsをバックエンドとしたブロックストレージ
- オンプレミス環境のディスクデータをAWS Strage Gateway経由でSnapshotとしてS3上に取得し、AWS環境でのDisaster Recovery（災害への予防措置）を実現
- iSCSIでブロックストレージとしてインターフェイスを提供
- オンプレミスのローカルディスクのバックアップを自動的にAWS側で実施
- Disaster Recovery用なので、更新データは非同期でAWSに転送
- オンプレミス側のStrage Gatewayへリストア（復元）
- AWS上でEBSディスクへのリストアも可能

##### テープゲートウェイ

- Strage GatewayをVTLとして利用することで、堅牢性の高い外部保管バックアップストレージを実現
- S3とGlacierにデータを保管する仮想テープストレージとVTL管理（仮想テープライブラリ）
- 長期のバックアップを想定
- VTL対応バックアップソフトウェアを利用し、Strage Gatewayを経由して、バックアップデータをS3およびGlacierに格納
- オンプレミス、およびEC2で利用可能
- バックアップソフトウェアにより、テープ取り出しオペレーションを行うことで、安価なアーカイブストレージ（S3、Glacier）を利用
- 主要なバックアップソフトウェアをサポート

## S3 Transfer Acceleration

- クライアントとS3バケットの間で、長距離にわたるファイル転送を高速、簡単、安全に実行
- 中央のバケットに対して世界中のお客様からアップロード、ダウンロードが行われる
- 大陸間で定期的にギガ、テラバイト単位のデータを転送する
- S3へのアップロード時にインターネット経由で利用可能な帯域幅を十分に活用できていないケースで選択する

## Snowball

- 物理ストレージデバイス（コンテナ）を使用し、インターネットを迂回してAWSとの大容量データ転送を高速化するサービス
- 容量の大きいデータをオンプレから移行したいとき、インターネットを使うと時間がかかりすぎる場合に使う
- オンプレミスのデータストレージロケーションとS3との間で、データのインポート、エクスポートができる
- すべてのリージョンで80TBモデルを使用可能
- 暗号化が強制、保管中や輸送中のデータを保護
- AWS Snowballマネジメントコンソールを使用
- オンプレミスのデータセンターとSnowball間でローカルデータ転送を実行

## 小テスト

- S3の設置場所は
  - 特定のリージョン

- STANDARD-IAの可用性は
  - ✗: 99.99999999999%
  - 99.9%
    - STANDARDは99.99%

- 利用頻度は低いため中長期保存したいデータがある。しかし、たまにデータを取り出すので、取り出しに時間がかかると業務に支障が出る。このデータはあまり重要ではない。コストを抑えたい場合にどのストレージを選択するべきか
  - One Zone-IA
    - STANDARD、STANDARD-IAに比べて最もコストが安く利用できる

- バケットとオブジェクトへのアクセス権限を設定する際に利用するアクセス管理方法は
  - バケットポリシー

- オブジェクト形式のストレージに関する説明として合っているものは
  - ✗: インスタンスストアで利用されている
  - ✗: EBSで利用されている
    - インスタンスストア、EBSはブロック型ストレージ
  - 安価かつ高い耐久性をもつストレージ
    - オブジェクト型ストレージは静的データに適したストレージシステムで、アジリティ（敏捷性）やフラット構造という特性から、膨大なデータを安価に高い耐久性を要して保存するのに向いている
    - オブジェクトにはアプリケーションがデータを迅速に検出するための十分な情報があり、構造化されていないデータの保存に適している

- 誤って削除してしまったオブジェクトデータの復元方法として正しいものは
  - バージョニングを利用して復元
    - ライフサイクル管理は移動、削除に利用する
    - 自動バックアップ、レプリケーションはRDSなどで利用する

- S3マネジメントコンソールのプロパティにある機能として間違っているものは
  - ✗: バージョン管理
  - ライフサイクル管理
    - ライフサイクル管理は『管理』にある機能

- S3を利用した静的ホスティングについて合っている内容は
  - ✗: アクセスコントロールリストを設定する必要がある
  - バケットポリシーを設定する必要がある
    - インターネットからアクセスできるようにする必要がある

- 次のうちS3サーバーサイドのデータ暗号化において利用できない暗号化形式は
  - CSE
    - クライアントサイドの暗号化方式の略称であり、間違い

- 次の暗号化方式の中でユーザー側で利用した暗号キーを利用するサーバーサイド暗号化形式は
  - ✗: SSE-S3
  - ✗: SSE-KMS
  - SSE-C
    - ユーザー側で用意した暗号化キーによってサーバーサイド暗号化を実施するのがSSE-C
    - SSE-Cを使用すると独自の暗号化キーを設定できる
    - リクエストの一部として用意された暗号化キーで、S3はディスクに書き込む際の暗号化とオブジェクトにアクセスする際の暗号の両方を管理する。なのでデータの暗号化と復号を実行するコードをユーザー側で管理する必要がない。必要なことはユーザーが用意する暗号化キーを管理することだけ
  