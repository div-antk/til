# EFS (Elastic File System)

複数のEC2インスタンスからアクセス可能な共有ストレージ

- S3
  - オブジェクト型のストレージでリージョンに設置
  - HTTPによるAPI経由でアクセス
  - 大容量のデータを長期保存するためのもの
- EBS
  - ブロック型のストレージでAZに設置。より高速に処理することができる
  - EC2インスタンスのディスクボリュームとして利用するが、物理的ではなくネットワーク経由で利用
    - 基本サーバーの記録ディスクとして利用する
  - 複数のEC2インスタンスにアタッチできない
- EFS
  - NASに似たファイルストレージ
  - ファイルシステムとして利用し、複数のEC2インスタンスでの共有アクセスが可能

## 特徴

その特徴はシンプルでスケーラブルで柔軟に利用できるファイルストレージであること

- シンプル
  - フルマネージド型サービス
  - 既存のNFSv4（操作クライアント）などのツールや、標準プロトコル/APIでアクセス可能
    - Network File System。分散ファイルシステム
- スケーラブル
  - ペタバイトまでスケーラブルにデータを蓄積
  - スループット/IOPS性能は自動的にスケーリングし、低レイテンシーを維持
- 柔軟性
  - ファイルの減少に合わせて自動で拡張、縮小
  - 事前に容量を設定する必要なし
  - 使った分だけの従量課金

## 基本性能

何千もの同時アクセスが実現可能という性能が特徴的

- 基本性能
  - 基本性能は100MB（バースト込み）
  - ファイル名は255バイト
  - 1ファイルの最大容量48TB
  - インスタンスあたり128ユーザーまでの同時オープンが可能
- 制限
  - アカウントあたりのファイルシステム数: 1,000
  - AZごとのファイルシステムあたりのマウントターゲット: 1
  - ファイルシステムあたりのタグ: 50
  - マウントターゲットあたりのセキュリティグループ: 5
  - ファイルシステムあたりのVPC数: 1
  - 各VPCのマウントターゲットの数: 400

## EFSのデータ保存

EFSのデータファイルは複数AZに分散して保存されている（フルマネージドで勝手に行われる）

## EFSの設定

EFS構築では次の設定を実施していく

- ファイルシステムを作成
- 接続先のマウントターゲットの作成
- セキュリティグループの作成
  - 他サービスと同様
- パフォーマンスモードの選択

### ファイルシステム

EFSの管理単位でファイルやディレクトリの保管場所。1つのAWSアカウントで複数のファイルシステムを作成できる

- ファイルシステムの中にディレクトリがある

### マウントターゲット

EC2インスタンスからの接続先になるのがマウントターゲット

- VPC内のAZにある接続先
- EC2インスタンスは同じAZ内にあるマウントターゲットから接続する
- 固定のDNS名とIPアドレスを有している
- ファイルシステムDNS名を使用してマウントすることで自動でIPアドレスクを付与

---

EC2インスタンスからマウントターゲットを介して、AZ外にあるEFSにアクセスできる

- EC2 -> マウントターゲット -> EFS
  - マウントターゲットはNFSv4のエンドポイントIPアドレスやDNS名を有する
  - 複数AZにある複数インスタンスから、それぞれのマウントターゲットを介してひとつのEFSにアクセスできる
    - データアクセスに課金なし。データ量に応じて課金する

### パフォーマンスモード

汎用モードと最大I/Oモードから選択。基本は汎用モード

- 汎用モード
  - 一般的な用途を想定したモード
  - デフォルトでは汎用モードとなり、かつ推奨されている
  - レイテンシーが最も低い
  - 1秒あたりのファイルシステム操作を7,000に制限
- 最大I/Oモード
  - 何十〜何千というクライアントからの同時アクセスが必要な、大規模な構築に利用（というかこういう場合にしか使わない）
  - 合計スループットを優先してスケールする
  - レイテンシーが多少長くなる

### バースト機能

ファイルストレージの負荷に対してバースト機能によってスケーラブルに対応

- NFSサーバー容量の増大に応じたスループット性能の拡張が必要
- 一時的なピーク時の負荷が増大する可能性

これらの負荷に対して **バースト機能でスケーラビリティを確保**

---

バースト機能は性能を一時的に向上させることができる

- バースト
  - 一時的な大量トラフィックの発生や、それに伴ってサーバなどの処理性能が一時的に向上する
- バーストスループットモード
  - ファイルシステムが大きくなるに従ってEFSによってスループットが拡大
- クレジットシステム
  - クレジットシステムによりファイルシステムがバーストできる時期を判断する
  - 各ファイルシステムは時間の経過とともにクレジットを蓄積していき、データを読み書きするたびにクレジットを追加する
  - 使わなかった分だけ貯金するみたいな？
