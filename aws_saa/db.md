# データベース

ワークロードに応じた最適なDB技術を利用する

## Performance Efficiency: パフォーマンス効率

システム要件のリソース最適化によりリソース使用量の削減

- システム要件を満たすためのコンピューティングリソースを効率化する
- システム要件やAWSサービスの進化に応じてAWSインフラの効率化を推進する
  - 最先端技術の一般化
  - グローバル化を即座に達成
  - サーバレスアーキテクチャの利用
  - より頻繁な実験をして新しいものを試していく

## パフォーマンス効率の主要サービス

### コンピューティング

- Auto Scaling
- Lambda

### ストレージ

- EBS
- S3
- Glacier
- EFS

### DB

- RDS
- DynamoDB
- Elastic search
- Aurora
- Redshift

### 容量と時間のトレードオフ

- Cloud Front
- Elastic Cache

## 5つの設計原則と11のベストプラクティス

今回のセクションは『パフォーマンス効率』の部分を多く占める

- スケーラビリティの確保
- キャッシュの利用
- 増大するデータ量対応
- 最適なDB選択
- サーバーではなくサービス
- 使い捨てリソースの使用

テスト範囲の50%を占める内容なのでしっかり理解する

## リレーショナルDB

DBの基本はリレーショナルDBシステム（RDBMS）。
業務システム向けの基本でもある

- 概要
  - データ間の関係性が定義されたデータを取り扱う一般的なDBシステム
  - 列と行がいくつかのテーブルで定義されていて、テーブル間のリレーションが設計される
  - データ操作にSQLを利用
  - 業務システムなどで最も頻繁に利用されるオペレーション用のDB
  - 利用者はSQLなどのクエリ言語でデータ操作を実施

- アーキテクチャ
  - テーブル間のリレーションが定義されたデータモデル
  - 行指向で1つの行をデータのかたまりとして取り扱う

- 利用データ
  - 会計データ、顧客データといった構造化データ

## NoSQL

IoTと同様に、ビッグデータ解析にはNoSQL DBを利用する。  
ここ数年、10年くらいで広まっていった

- 概要
  - リレーショナルデータ構造を持たずにSQLを利用しないDBの総称
  - ただし、現在は操作しやすいように一部SQLやSQLに似たクエリ処理を適用したモデルもある
  - 構造が軽いので、大量のデータを扱うのに向いている

- 利用データ
  - 構造化されていないKeyとValueのみ（ID番号一列に全データを格納）のKVSデータ
  - 動画、画像、ドキュメントなどの非構造化データ
  - XML/JSONなどの半構造化データ

### 非構造化

テキスト、動画、音声

### 半構造化

XML、JSON、文書

---

**キーに対するデータ形式の格納方法の違い**で、様々なタイプのNoSQLが存在する

### キーバリューストア

- 一番ポピュラー
- キーに対してバリュー（値）を入れる単純な構造
- 高速なパフォーマンスと分散型拡張に優れている
- データ読み込みが高速

### ワイドカラムストア

- 二番目にポピュラー
- 『列指向』とも呼ばれ、キーを利用するがデータはカラム（列）で管理する
- 非構造化データを大規模に格納することを目的にしている
- 行ごとに任意の名前のカラムを無数に格納できる
  - キーバリューストアより格納するデータや形式が柔軟

## ビッグデータの活用

データの特徴に応じて利用するDBを選択する

## データウェアハウスDWH

構造化データを利用した経営分析向けのDB。  
売り上げ分析、財務分析など目的に沿った業務データ分析

- 概要
  - データの抽出、集約に特化したBI（ビジネスインテリジェンス）データ分析用のDB
  - 読み込むデータ構造を予め設定する必要がある（こういうふうに設計してこういうふうにデータを使う、など）。加工してから利用分のデータを蓄積
  - レスポンス重視でデータ抽出や集計は早いが、更新、トランザクションは遅いので、業務処理用のDBとしては使いづらい

- アーキテクチャ
  - データをパーティショニングして、複数ディスクから読み込む
  - 列指向でデータを格納

- 利用データ
  - 会計データなどの業務系の構造化データを分析用に加工し、BIで利用
  - KPI測定、競合分析、アクセス分析など

- オンプレ、ソフトウェア
  - ORACLE Exadata
  - Veritica
  - Teradate
  - Greenplum

- AWSサービス
  - Redshift

## 分散型DB、データレイク

ビッグデータやIoTデータを蓄積して高速処理を可能にするDBとストレージの組み合わせ。  
S3はデータを蓄積するというところに特化している

- 概要
  - データ抽出に特化したDB
  - 分散してデータを保存しており、ビッグデータの高速処理向け

- アーキテクチャ
  - SQLライクなクエリで操作可能なものもある
  - `INSERT` , `UPDATE` , `DELETE` はない
  - トランザクションもない
  - データ書き込みは一括ロード、または全件削除のみ

- 利用データ
  - ビッグデータ、IoTのデータ

- オンプレ、ソフトウェア
  - Impalam, Hive, presto + HDFS

- AWSサービス
  - S3

## KVS: キーバリュー型

シンプルなデータ構造にすることで高速処理を可能にしたDB

- 概要
  - 分散して、シンプルなオペレーションを高速に実施できるDB

- アーキテクチャ
  - 強い整合性を犠牲にして、結果的な整合性を採用。結果的に整合すればOK
  - 分散向けのデータモデル、クエリの採用
  - トランザクション、集計、JOINなど、複雑なデータを構成し直す処理はできない。あくまで高速処理に特化している

- 利用データ
  - 大規模WEBサイトのバックエンドデータ
    - ユーザセッション、ユーザ属性、事前計算データのキャッシュ
  - メッセージングシステムのデータ（ツイッターみたいな）
  - 大規模書き込みが必要なIoTセンサーデータなど

- オンプレ、ソフトウェア
  - redis
  - riak

- AWSサービス
  - ElastiCache
  - DynamoDB

### キーバリュー型DBのテーブル

リレーショナルな構造なしに、一行にデータをまとめることで高速処理を可能にする（データの格納の仕方が単純なため）

| キー  | バリュー                    |
| --- | ----------------------- |
| 1   | 名前:佐藤、部門:総務、場所:三鷹、役職:部長 |
| 2   | 名前:上原、部門:人事、場所:新宿、役職:課長 |
| 3   | 名前:村上、部門:製造、場所:新宿、役職:社員 |

- キーに応じてデータを分散して処理することができる

| キー  | バリュー |
| --- | ---- |
| 001 | 佐藤   |
| 002 | 上原   |
| 003 | 村上   |

| キー  | バリュー |
| --- | ---- |
| 201 | 森   |
| 202 | 菊池   |
| 203 | 中川   |

| キー  | バリュー |
| --- | ---- |
| 401 | Bob  |
| 402 | Jane |
| 403 | Dave |

### アーカイブ（構造化アーカイブデータ）

- データウェアハウスだけでは不可能だった長期過去データを活用した業務データ分析

### 半構造化DB（半構造化データ）

- IoTデータなどの膨大なビッグデータを活用した分析、人工知能構築

### 非構造化DB（非構造化データ）

- 非構造化データを利用したデータ分析、人工知能構築

## ワイドカラム型

キーに対してカラムを大規模に登録できるのがワイドカラム型。  
これもキーバリューストアでよく使われる形式

- 概要
  - 分散して、シンプルなオペレーションを高速に実地できるDB
  - データ取得する際にデータ結合しなくても済むように、可能な限り多くのデータを同じ行に保持
- アーキテクチャ
  - 結果整合性を採用
  - キースペース、カラムファミリ、ロウ、（スーパーカラム）カラムの入れ子構造
  - SQLライクなデータ操作が可能
  - データ操作は挿入、削除、参照のみで、データの更新は挿入による上書きしかできない
- 利用データ
  - Facebook/Twitterなどソーシャルデータの位置情報データストレージ、リアルタイム分析、データマイニング処理
- オンプレ、ソフトウェア
  - Cassandra
  - Apache HBASE
- AWSサービス
  - DynamoDB

---

キーとカラムが入れ子構造となったデータモデルを利用

- KeySpace1
  - Column family 1
    - RouID1
      - Name: xxx, Value: xxx, Timestamp: xxx
      - Name: xxx, Value: xxx, Timestamp: xxx
      - Name: xxx, Value: xxx, Timestamp: xxx
    - RouID2
      - Name: xxx, Value: xxx, Timestamp: xxx
      - Name: xxx, Value: xxx, Timestamp: xxx
      - Name: xxx, Value: xxx, Timestamp: xxx
  - Column family 2
    - RouID1
      - Name: xxx, Value: xxx, Timestamp: xxx
      - Name: xxx, Value: xxx, Timestamp: xxx
      - Name: xxx, Value: xxx, Timestamp: xxx
    - RouID2
      - Name: xxx, Value: xxx, Timestamp: xxx
      - Name: xxx, Value: xxx, Timestamp: xxx
      - Name: xxx, Value: xxx, Timestamp: xxx

## ドキュメントDB

キーに対してドキュメント指向でXMLなどのデータを格納する。  
キーに対してバリューではなく、JSONやXMLなどのデータを格納。  
複雑なデータ構造を扱うアプリで生産性高く柔軟に開発する

- 概要
  - ドキュメント指向データベースでは、さまざまなデータ構造のドキュメントを混在して保持することができる
- アーキテクチャ
  - JSON/XMLをデータモデルに利用
  - 小規模データの同期集計処理が可能だが、バッチは不向き
  - SQLライクなデータ操作が可能で、KVSよりもクエリが豊富なため操作しやすい
  - Shardingによるデータベース分散化
- 利用データ
  - 半構造化データ（XML/JSON）
  - 大規模WEBのログ保管など
  - オンラインゲームデータ
  - カタログのデータ管理
- オンプレ、ソフトウェア
  - mongoDB
    - 一番有名
  - MarkLogic
  - CouchDB
  - Couchbase
- AWSサービス
  - Amazon DocumentDB
  - mongoDB
    - AWS内に構築して利用する

---

様々な形式のドキュメント構造を一緒に保存できる

## インメモリデータグリッド

KVSの仕組みを、メモリを利用してより高性能にしたDB

- 概要
  - 大量のデータを多数のサーバのメモリ上で分散して管理する技術
  - ミリ秒単位の高速な応答処理が可能
- アーキテクチャ
  - データをメモリ上に置くことで、高速なデータアクセスを実現
  - データを多数のサーバで分散して管理
- 利用データ
  - 金融の取引処理データでミリ秒以下の応答時間を求められるようなサービスに使う
- オンプレ
  - ApacheGEODE
  - Oracle Coherence
  - Hazelcast
  - Apache Ignite
  - Infinispan
- AWSサービス
  - Redis ElastiCache
  - Memcached ElastiCache

## 全検索エンジン×分散DB

データの全検索エンジンであるElasticsearchは、分散DBと連携してデータ全検索処理が可能

- 概要
  - 全検索型のデータ検索エンジンで、分散DBと連携して検索DBを構築
  - 検索条件との関係性、関連性が高いデータを抽出して返す
- アーキテクチャ
  - Elasticsearchは全文検索用のライブラリ、Apache Luceneを利用したデータストア
  - 分析の柔軟性や速度が高く、分析、蓄積、可視化環境を用意に構築可能
- 利用データ
  - 半構造化データ（XML/JSON）
  - 高加用な全検索エンジン
  - サイト内データの検索
  - デバイス登録状況、配信状況のリアルタイム可視化など、リアルタイム検索要件、検索行動の可視化
- オンプレ、ソフトウェア
  - elasticsearch
  - Kibana
- AWSサービス
  - Elasticsearch Searvice

## グラフデータベース

最も特殊なDB。  
グラフ構造でデータ間のつながりを検索、可視化するDB。  
グラフ理論に基づき、データ同士の関係をグラフで相互に結びついた要素で構成される。  
RDBと比較して高速横断検索が可能

- 概要
  - グラフ演算に特化したDBで、データ間のつながり方を検索、可視化に利用
- アーキテクチャ
  - グラフデータ構造を取るため、RDB以上にスケールアウトができない
  - レコード数が増えると、検索にかかる時間と難易度が増大
  - ACID特性が担保されており、オブジェクト間の関連付けを簡単に表現できる
    - ACID特性とは
      - Atomicity（原子性）
      - Consistency（一貫性）
      - Isolation（独立性）
      - Durability（永続性）
- 利用データ
  - 最短経路探索
  - 金融取引の詐欺検出
  - ソーシャルネットワークによるリレーション計算
- オンプレ、ソフトウェア
  - neo4j
- AWSサービス
  - Amazon Neptune

---

グラフ構造はマインドマップのようにデータ関連をグラフ表示するデータ構造

## 分散OLTP（RDB）

オンライントランザクション処理（Online Transaction Processing）を分散化する次世代DB

- 概要
  - グローバルに分散され、強制合成を備えたDB
  - 基本リレーショナルDBは分散型ではなく、分散型にするのはNoSQLである。分散型で構築できるRDBが、新しいクラウド型のRDBであるOLTP
- アーキテクチャ
  - リレーショナルDBの構造と、非リレーショナルDBの分散スケーラビリティを兼ね備える
  - 高い可用性、高性能のトランザクションと強整合性が実現
- 利用データ
  - 大規模な業務データ処理を高速で行う
- オンプレ、ソフトウェア
  - なし。そもそもクラウドでRDBを最適化するために作られたものである
- AWSサービス
  - AWS Aurora
    - より高性能で低コストで大規模な構築をしたい場合に使う

## DB種別とデータモデル

上から順にシンプルで分散しやすく、下にいくにつれて複雑なデータ処理向けになる

- NoSQL
  - KVS
  - ワイドカラム
  - ドキュメント
- RDB
- NoSQL
  - グラフDB