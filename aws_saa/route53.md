# Route53

権威DNSサーバの機能をマネジメント型で簡単に利用できるサービス

- 主要機能はドメイン登録、DNSルーティング、ヘルスチェックの3つ
- ポリシーによるルーティング設定
  - トラフィックルーティング、フェイルオーバー、トラフィックフローに基づく様々な条件のルーティング設定が可能
- AWS側で100%可用性を保証するSLA（サービス品質保証）
  - 「絶対に落ちないよ」という保証
- マネージドサービスとして提供しており、ユーザー側で冗長性などを考慮する必要がない

## DNS (Domain Name Service)

DNDはインターネットにおける人向けのURLを、システム向けの住所となるIPアドレスに変換するための仕組み

- 名前解決機能があるものを**権威DNSサーバ**
- 一時的にDNS情報を企業のサーバに保持しておくことで名前解決がすぐできるようにすることに使われるものを**キャッシュDNSサーバ**

Route53はAWSが提供する権威DNSサーバで、ポート53で動作することからRoute53と呼ばれる

- **DNSレコード**というIPアドレスとURLを紐づけた表を確認してルーティングする

## 利用方法

Route53の利用を開始してドメインを登録するとホストゾーンを自動生成し、そこにルーティングを設定する

1. Route53にドメインを設定
2. ドメイン名と同じホストゾーンを自動生成
3. ホストゾーンにルーティング方法となるDNSレコードを作成
4. トラフィックルーティングを設定

## ホストゾーン

ドメイン（example.com）とそのサブドメイン（sub.example.com）のトラフィックのルーティングする方法についての情報を保持するコンテナ

### パブリックホストゾーン

- インターネット上に公開されたDNSドメインレコードを管理するコンテナ
- インターネットのDNSドメインに対するトラフィックのルーティング方法を定義

### プライベートホストゾーン

- VPCに閉じたプライベートネットワーク内のDNSドメインのレコードを管理するコンテナ
- VPC内のDNSドメインに対して、どのようにトラフィックをルーティングするかを定義
- 1つのプライベートホストゾーンで複数VPCに対応
- VPCが相互アクセス可能であれば複数リージョンのVPCでも、同じホストゾーンを利用可能

## DNSレコード

ルーティング方法を設定するためにDNSレコードを作成し、各種レコードを設定するのがDNSを使う基本になる

### SOA

- ドメインのDNSサーバ、ドメイン管理者のメールアドレス、シリアル番号などを保持して、ゾーン転送時に情報が更新されているかの判断に利用する
- トップレイヤー

### A

- ホスト名とIPアドレスの関連づけを定義するレコード
- 非常に重要なレコード

### MX

- メール用
- メールの配送先（メールサーバ）のホスト名を定義するレコード

### CNAME

- 正規ホスト名に対する別名を定義するレコード。特定のホスト名を別のドメイン名に転送するときなどに利用する
- URLを変更したりするときとか

### ALIAS (Route53固有の仮想リソースレコード)

- DNSクエリにAWSサービスのエンドポイントのIPアドレスを返答
- 以下のサービスを設定可能
  - 静的ウェブサイトとして設定されたS3バケット
  - CloudFront
  - ELB
  - ホストゾーン内のリソースレコードセット
    - 静的WEBサイトとして設置されたS3バケット、CloudFront、ELBなど

#### ALIASレコードのメリット

- DNSクエリに対するレスポンスが高速
- CNAMEにマッピングできないZone Apex（ドメイン名そのもの）を設定可能
- ALIASレコードに対するクエリが無料であり、Route53と連携したDNS Lookupを高速化する
- CloudFrontでのクエリ回数を削減

## トラフィックルーティングのタイプ

様々なルーティング方式を選択して設計することが可能

### シンプルルーティング（Simple）

- レコードセットで事前に設定された値のみに基づいてDNSクエリに応答する
- 静的なマッピングによりルーティングを決定

### 加重ルーティング（Weighted）

- 複数エンドポイントごとの重み設定によりDNSクエリに応答する
- 7:3などで分けた場合などの、重み付けの高いエンドポイントに多くルーティングする

### レイテンシールーティング（Latency）

- リージョンの遅延によりDNSに応答する
- リージョン間の遅延が少ない方へルーティングされる

### フェイルオーバールーティング（Failover）

- ヘルスチェックの結果に基づいて、利用可能なリソースをDNSクエリに応答する
- 利用可能なリソースにのみルーティングされる

### 位置情報ルーティング（Geolocation）

- クライアントの位置情報に基づきDNSクエリに応答する
- 特定の地域、国からのDNSクエリに対して特定のアドレスを応答
  - 例えば日本のクエリに対して日本のサーバを使ったり、国ごとによってトップページの言語を変えたりといったことが可能

### マルチバリュールーティング

- 別々のレコードにIPアドレスを設定する
- IPアドレス単位でヘルスチェックを実施してルーティングする
  - それまでのヘルスチェックのルーティングは、ひとつのレコードに複数のIPアドレスを紐づけることにより、IPアドレス単位でヘルスチェックができない

## トラフィックフロー

従来はALIASレコードを駆使して複雑なルーティングポリシーを作成していたが、トラフィックフローによる視覚的なフローマッピングでの複雑なポリシー設定が可能になった

## ホストゾーンの設定ハンズオンのメモ

- Route53から『ドメインの登録』
  - 年額いくらでドメインが売っている
- 『DNS管理』から既存のドメインを使う
  - 『ホストゾーンを始める』からドメインを入力してパブリックを選択
  - 作成したらネームサーバーの『値』をコピーして『お名前.com』に貼り付けていく（4点）

### シンプルルーティングのハンズオンのメモ

1. NslookupコマンドでドメインとIPが設定されたか確認する
2. シンプルルーティングを設定して、ドメイン名でWEBページが表示されたかを確認する

- ターミナルで `nslookup ドメイン名`
  - 『ドメインが見つからない』という結果が返ってくる。これはルーティングの設定がグローバルに反映されるまで、数時間〜数日かかる
- （反映されたら）コンソールから『レコードセットの作成』
  - 『名前』は空欄でもいい
  - 『エイリアス』で「はい」にチェックを入れて、以前作ったELBを選択する
  - 『ルーティングポリシー』を「シンプル」にして作成
- Aレコードが作られたのがわかる。ドメインをブラウザに打ち込むとページが表示される

リージョン間を跨いだEC2インスタンス同士をルーティングする

- EC2をAMIから作成。既存のセキュリティグループなどを使う
- 上記は東京リージョンに作った。こんどは別リージョンに作る
  - 『AMIのコピー』を選択するとリージョンが選べる。今回はシンガポールとシドニーにコピーした。作成には時間がかかる
- シンガポールとシドニー、それぞれのリージョンに移動してAMIからインスタンス作成。vpcはデフォルト、キーペアもそれぞれ作成する
- 作成後、ターミナルからそれぞれのインスタンスに入り、htmlファイルに国の名前を書いておく
  - キーペアは `chmod 600` で権限を変更する必要がある
- コンソールのシンプルルーティングの画面に戻る
- 上で作った『A』のレコードセットを削除する
- 『レコードセットの作成』から『値』の部分に3リージョンそれぞれのグローバルIPアドレスを貼り付けて作成
- ドメインにアクセスするとどれかのリージョンにアクセスする（規則性などは特にない）

### 加重ルーティングのハンズオンのメモ

- シンプルルーティングのレコードセットは削除してよい
- 『作成』から東京リージョンにあるインスタンスのパブリックIPを『値』にコピペ
  - ルーティングポリシーを『加重』
  - 加重を50に設定
  - セットIDを sample01
  - ヘルチェックの関連付けは「いいえ」
  - 作成すると「重量50」のものが作成される
- シンガポールリージョンで同じく作成。加重は25。sample02
- シドニーで同じく作成。加重は25。sample03
- 50:25:25 のレコードセットが作成される
- ドメインにアクセス。加重によってアクセス先が変わる（今回はシンガポールしか出なかったが）

### レイテンシールーティングのハンズオンのメモ

- 上と同じくレコードセットは削除してよい
- 『作成』から各リージョンにあるインスタンスのパブリックIPを『値』にコピペしてそれぞれ作成していく
  - ルーティングポリシーを『レイテンシー』。選ぶと自動的にIPアドレスに適したリージョンが設定される。こちらのリージョンのレイテンシーを見て優先度が決められる
    - 同じリージョンであればIPを2つ以上セットしてもよい
- ドメインにアクセス。今回は東京が出る。東京に住んでいるので東京が低レイテンシーになりやすい傾向にはなる

### 位置情報ルーティングのハンズオンのメモ

- 『作成』から東京リージョンにあるインスタンスのパブリックIPを『値』にコピペ
  - ルーティングポリシーを『位置情報』
  - 『場所』で「アジア」
    - アジアにいる人は東京リージョンにアクセスさせるようになる
- シンガポールでは『欧州』（実際は不適切ではあるが）
- シドニーでは『オセアニア』を選んで作成
- ドメインにアクセス。（当然）東京リージョンが出る

### マルチバリュールーティングのハンズオンのメモ

1. ヘルスチェック機能の設定
2. マルチバリュールーティングを設定する
3. ドメイン名でWEBページが表示されるかを確認する

シンプルルーティングではひとつのレコードにすべてのIPアドレスをセッティングした。で、レコード単位ではヘルスチェックをしてくれるけど、ひとつひとつのIPアドレスに対してはヘルスチェックが行われない。  
マルチバリュールーティングではひとつひとつのIPアドレスのヘルスチェックをしてルーティングをしていく。

- ダッシュボードから『ヘルスチェックの作成』でリージョンごとに下記で作成していく
  - 名前つける
  - 『モニタリングの対象』は「エンドポイント」
    - IPアドレスやインスタンスのヘルスチェックに使うものである
  - 『エンドポイントの監視』ではインスタンスのIPアドレス、パスに `index.html` それ以外はそのまま。次へ
  - アラームのチェックは「いいえ」でヘルスチェックの作成完了
- メニューから『レコードセットの作成』でそれぞれのリージョンのものを作成
  - IPアドレス
  - ルーティングポリシーを『複数値回答』
  - セットIDを `sample数字`
  - 『ヘルスチェックとの関連付け』で「はい」にチェック。上で作成したそれぞれのリージョンに
対応したヘルスチェックを指定
- 確認のために東京リージョンのEC2インスタンスを停止
- Route53でヘルスチェックを見る。しばらくすると東京リージョンのステータスが異常になっている
- （当然）ドメインにアクセスすると東京リージョンのものは表示されなくなる
