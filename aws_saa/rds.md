# RDS

様々なDBソフトウェアに対応したフルマネージドなリレーショナルDB

- 以下のような標準ソフトウェアを利用したDBを構築できる
  - MySQL
  - ORACLE
  - Microsoft SQL Server
  - PostgreSQL
  - MariaDB
  - Amazon Aurora
    - Amazonが作ったものでちょっと使用が違う

## AWSのDB構築

AWSにおけるDB構築はEC2に自らインストールしてDBサーバとして構築するか、専用DBサービス（RDSなど）を利用するかの2通り

- EC2に構築する場合
  - メリット: 自由にDB構成や機能を利用
  - デメリット: 構築、運用が手間
    - モニタリングなど、ユーザーが管理しなければならない
- RDSなどに構築する場合
  - メリット: 構築、管理がマネージドサービスなので楽（大部分がAWS側）
  - デメリット: AWS提供の範囲内での利用制限
    - バージョンがすべて使えるわけでもない、など。詳細下記

## RDSの制約事項

- バージョンが限定される
  - 最新バージョンはすぐに使えない
- キャパシティに上限がある
- OSへのログインができない
- ファイルシステムへのアクセスができない
- IPアドレスが固定できない
- 一部の機能が使えない
- 個別パッチは適用できない
  - ソフトウェアの会社からパッチが配布されてもそれはAWSの管理しているところである

## 特徴

- RDS自体がマネージド型の高加用なのに加え、マルチAZによるMaster、Slave構成を用意に構築することができる
  - 同期レプリケーションや自動フェイルオーバーによって信頼性や耐障害性を担保できる
- 非同期で参照専用のリードレプリカを最大5台（Auroraは15台）設置し、DBの読み取り処理をスケールアウトできる
- 自動、手動でスナップショットやトランザクションログを取得してS3に保存管理し、耐障害性を確保

## スケーリング

マネージメントコンソールやAPIからスケールアップ可能

- インスタンスタイプを変更してスケールアップ、ダウンを実施
- コマンドライン（AWS CLI）やAPIからストレージを数クリックで用意にスケールアップ、ダウンする
- 一時的にインスタンスタイプを大きくして、その後戻すことも可能
- ストレージサイズは拡張はできるが縮小はできない
- データベースシャーディング（水平分割。1つのテーブルに入っているレコードを別のDBに分散する）を利用してRDSの書き込み処理をスケーリングする。シャーディングソフトウェアのインストールが必要
  - ID0〜1000まではRDSマスター1、ID1001〜2000まではRDSマスター2など

## DBインスタンスの暗号化

保管時のインスタンスとスナップショットの暗号化が可能

- 暗号化対象
  - DBインスタンス
  - 自動バックアップ
  - リードレプリカ
  - スナップショット

- 暗号化方式
  - AES-256暗号化
  - AWS KMSによる鍵管理（セキュリティーキー）
  - リードレプリカも同じ鍵を利用
  - インスタンス作成時にのみ暗号化の設定可能
  - スナップショットのコピーの暗号化、リストア可能

## RDSの構築ハンズオンのメモ

- RDSの『サブネットグループ』から作成
  - AZで『a』と『c』を選択
  - サブネットでプライベート（奇数のもの。今回は1と3）を選択して作成
- 『データベース』から作成
  - MySQLを選択
    - バージョンは自社のオンプレで使っているものと合わせるのが好ましい
    - 『テンプレート』の無料枠だとマルチAZ構成をすることができない。今回は『開発/テスト』を選択。1ヶ月で1万円くらいかかるのですぐ削除する
    - DBインスタンスサイズがデフォルトのままだとXLサイズなので高額。『バースト可能クラス』でmicroを選択し、ストレージもSSDを選択して金額を抑えることができる
    - 『マルチAZ配置』にチェックを入れるとaとcに自動でRDSを2つぶん作ってくれる（なのでそのぶん値段が倍になる）
      - チェックを入れて作成をするとエラーになる場合もあるっぽい。その場合はチェックを外して作ったあとからでも設定できる
    - 『接続』の『追加の接続設定』でサブネットグループを選択（さっきaとcを選んだやつ）
      - セキュリティグループを新規で作る。今回は `db-sg` という名前
    - 『追加設定』で名前やモニタリング設定などできるが今回はとくになし
- 作成。できるまで10分かそれ以上かかる

## RDSのマスタースレーブ構築ハンズオンのメモ

- 作ったRDSのセキュリティーグループをクリックして『ソース』のIPを見てみると、32しかアクセスできないという設定になっている。これだとEC2インスタンスからアクセスできない
  - 使いたいEC2インスタンスのIPにするか、フルオープン（ `0.0.0.0/0` ）で設定する
- RDSからDBをクリックしてエンドポイントのURLをコピー
- ターミナルでEC2にアクセスしてルート権限になってからmySQLのインストール
  - `yum install mysql -y`
  - `mysql -h コピーしたエンドポイント -u ユーザー名 -p` からパスワード入力でDBに入れる
  
```bash
# DB作る
create database testdb;

# DB切り替え
use testdb;

# テーブル作る
create table testdb.account(id int, name varchar(20));

# テーブル見る
show tables;

# データ入れる
insert into account values(1001, "takuya");

# データ見る
select * from account;
```

## RDSのSnapshotからの復元ハンズオンのメモ

- DBを選択して『スナップショットの取得』
  - 名前適当につける
- スナップショット作成後、ターミナルに戻って適当なデータを1つ入れる
- 『スナップショットの復元』を選択（しばらくしないと選択できないぽい？）
  - DBをもうひとつ作るといったカタチになる
    - micro、マルチAZにチェック、DB識別子、既存のVPCでさっきのやつ（デフォルトは消す）。他そのままで『DBインスタンスの復元』
- しばらくして『利用可能』になったあと、上と同じくテーブル見るとこまで行く
- すると3つ目のデータが入ってない状態で復元されたのがわかる
- Snapshotは自動的にS3に入ることになっている

## RDSのバックアップからの復元ハンズオンのメモ

- 『Automated backups』から特定時点への復元
  - インスタンスクラスでmicro、マルチAZチェック、識別子にまた別の名前で作成
- あとはSnapshotと同じ。すると3つ目のデータが入っているものが復元されたのがわかる

## RDSのリードレプリカとフェイルオーバーのハンズオンのメモ

- 最初に作ったDBを選択してRDSの作成
  - micro、マルチAZはリードレプリカなのでチェック無し、AZを `1a` で選択、あとはそのままで『作成』
- レプリカができる

### フェイルオーバーのチェック

- 最初に作ったDBのAZが1aから1cに動くかを確認する
- アクションから再起動。『フェイルオーバーし再起動』
- 再起動が完了すると1cのSlaveに動いたのがわかる
